#### This playbook tests Dataplane Telemetry (DTel)
- block:
    - fail: msg="Please set ptf_host variable"
      when: ptf_host is not defined

    - name: Ensure LLDP Daemon stopped
      become: yes
      supervisorctl: state=stopped name={{item}}
      vars:
        ansible_shell_type: docker
        ansible_python_interpreter: docker exec -i lldp python
      with_items:
        - lldp-syncd
        - lldpd

    - name: Remove existing ip from ptf host
      script: roles/test/files/helpers/remove_ip.sh
      delegate_to: "{{ ptf_host }}"

    - name: Install test ip to ptf host
      script: roles/test/files/helpers/add_ip.sh
      delegate_to: "{{ ptf_host }}"

    - name: Generate key in mgmt for ptf host
      shell: ssh-keygen -b 2048 -t rsa -f /tmp/id_rsa -q -N ""
      args:
        creates: /tmp/id_rsa

    - name: Copy key to PTF host
      copy: src=/tmp/id_rsa.pub dest=/root/.ssh/authorized_keys
      delegate_to: "{{ ptf_host }}"

    - name: Generate key in ptf host for DUT
      shell: ssh-keygen -b 2048 -t rsa -f /tmp/ptf_key -q -N ""
      args:
        creates: /tmp/ptf_key
      delegate_to: "{{ ptf_host }}"

    - name: Fetch key from ptf host
      fetch:
        src: /tmp/ptf_key.pub
        dest: /tmp/ptf_key.pub
        flat: yes
      delegate_to: "{{ ptf_host }}"

    - name: Copy key to PTF host
      copy: src=/tmp/ptf_key.pub dest=/home/admin/.ssh/authorized_keys

    - name: Print vars
      debug: msg={{ hostvars[item]['ansible_host'] }}
      with_items: "{{ ptf_host }}"

    - name: Create tunnel for Redis
      connection: local
      shell: ssh -4fN -i /tmp/id_rsa -R 8888:{{ ansible_host }}:22 root@{{ hostvars[item]['ansible_host'] }}
      with_items: "{{ ptf_host }}"

    - name: Copy ptf tests to the container
      copy: src=roles/test/files/ptftests dest=/root
      delegate_to: "{{ ptf_host }}"

    - include: ptf_runner.yml
      vars:
        ptf_test_name: DTel INT EP test - {{ item }}
        ptf_test_dir: ptftests/dtel/tests
        ptf_test_path: dtel_int_l45_ep.{{ item }}
        ptf_platform: remote
      with_items:
        - INT_UDP_SourceTest
        - INT_UDP_SinkTest
      when:
        - ( {{ with_int_transit }} is not defined) or ( {{ with_postcard }} is not defined)

    - include: ptf_runner.yml
      vars:
        ptf_test_name: DTel INT Transit test - {{ item }}
        ptf_test_dir: ptftests/dtel/tests
        ptf_test_path: dtel_int_l45_transit.{{ item }}
        ptf_platform: remote
      with_items:
        - INT_TransitTest_switchid
        - INT_TransitTest_hop2_port_ids
        - INT_TransitTest_Ebit
        - INT_TransitTest_hop2_qdepth
        - INT_TransitTest_Metadata
      when:
        - {{ with_int_transit }} is defined

    - include: ptf_runner.yml
      vars:
        ptf_test_name: DTel Postcard test - {{ item }}
        ptf_test_dir: ptftests/dtel/tests
        ptf_test_path: dtel_postcard.{{ item }}
        ptf_platform: remote
      with_items:
        - PostcardTest
      when:
        - {{ with_postcard }} is defined

    - include: ptf_runner.yml
      vars:
        ptf_test_name: DTel Queue test - {{ item }}
        ptf_test_dir: ptftests/dtel/tests
        ptf_test_path: dtel_queue.{{ item }}
        ptf_platform: remote
      with_items:
        - QueueReport_Quota_Test

    - include: ptf_runner.yml
      vars:
        ptf_test_name: DTel Drop test - {{ item }}
        ptf_test_dir: ptftests/dtel/tests
        ptf_test_path: dtel_drop.{{ item }}
        ptf_platform: remote
      with_items:
        - IngressDropTest

  always:
    - name: Remove existing ip from ptf host
      script: roles/test/files/helpers/remove_ip.sh
      delegate_to: "{{ ptf_host }}"

    - name: Close tunnel
      connection: local
      shell: ps aux | grep 'ssh -4fN' | grep -v grep| awk '{print $2}' | xargs kill -9

    - name: Restore LLDP Daemon
      become: yes
      supervisorctl: state=started name={{ item }}
      vars:
        ansible_shell_type: docker
        ansible_python_interpreter: docker exec -i lldp python
      with_items:
        - lldpd
        - lldp-syncd

